/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2017 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./defined-b9ff0e39","./Check-e6691f86","./freezeObject-2d5b18ce","./defaultValue-199f5aa8","./Math-2145e044","./Cartesian2-40ed5530","./defineProperties-ae15c9d5","./Transforms-94513c2d","./RuntimeError-d5522ee3","./WebGLConstants-554ddbe2","./ComponentDatatype-9477db2c","./when-c208a7cf","./AttributeCompression-a7396e6f","./IndexDatatype-668aa2f9","./IntersectionTests-f6d27a39","./Plane-297770b0","./WebMercatorProjection-a290a2f5","./createTaskProcessorWorker","./EllipsoidTangentPlane-1ba7ce65","./OrientedBoundingBox-d258fabd","./TerrainEncoding-b01d1123"],function(fe,e,t,r,Te,pe,i,ye,n,a,o,s,xe,Ne,c,d,Me,u,be,Ce,ve){"use strict";var we=32767,Ae=new pe.Cartesian3,Ee=new pe.Cartesian3,Pe=new pe.Cartesian3,Se=new pe.Cartographic,Be=new pe.Cartesian2,Fe=new pe.Cartesian3,Ve=new ye.Matrix4,We=new ye.Matrix4;function _e(e,t,r,i,n,a,o,s,c){var d=Number.POSITIVE_INFINITY,u=n.north,h=n.south,m=n.east,I=n.west;m<I&&(m+=Te.CesiumMath.TWO_PI);for(var l=e.length,g=0;g<l;++g){var f=e[g],T=r[f],p=i[f];Se.longitude=Te.CesiumMath.lerp(I,m,p.x),Se.latitude=Te.CesiumMath.lerp(h,u,p.y),Se.height=T-t;var y=a.cartographicToCartesian(Se,Ae);ye.Matrix4.multiplyByPoint(o,y,y),pe.Cartesian3.minimumByComponent(y,s,s),pe.Cartesian3.maximumByComponent(y,c,c),d=Math.min(d,Se.height)}return d}function ke(e,t,r,i,n,a,o,s,c,d,u,h,m,I,l,g,f,T){var p,y,x;x=m?(p=n.length-1,y=-1):(p=0,y=n.length,1);var N=-1,M=fe.defined(c),b=t/a.getStride(),C=u.north,v=u.south,w=u.east,A=u.west;w<A&&(w+=Te.CesiumMath.TWO_PI);for(var E=p;E!==y;E+=x){var P=n[E],S=o[P],B=s[P];Se.longitude=Te.CesiumMath.lerp(A,w,B.x)+f,Se.latitude=Te.CesiumMath.lerp(v,C,B.y)+T,Se.height=S-h;var F,V=d.cartographicToCartesian(Se,Ae);if(M){var W=2*P;if(Be.x=c[W],Be.y=c[1+W],1!==I){var _=xe.AttributeCompression.octDecode(Be.x,Be.y,Fe),k=ye.Transforms.eastNorthUpToFixedFrame(Ae,d,We),H=ye.Matrix4.inverseTransformation(k,Ve);ye.Matrix4.multiplyByPointAsVector(H,_,_),_.z*=I,pe.Cartesian3.normalize(_,_),ye.Matrix4.multiplyByPointAsVector(k,_,_),pe.Cartesian3.normalize(_,_),xe.AttributeCompression.octEncode(_,Be)}}a.hasWebMercatorT&&(F=(Me.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Se.latitude)-l)*g),t=a.encode(e,t,V,B,Se.height,Be,F),-1!==N&&(r[i++]=N,r[i++]=b-1,r[i++]=P,r[i++]=b-1,r[i++]=b,r[i++]=P),N=P,++b}return i}function He(e,t){var r;return"function"==typeof e.slice&&"function"!=typeof(r=e.slice()).sort&&(r=void 0),fe.defined(r)||(r=Array.prototype.slice.call(e)),r.sort(t),r}return u(function(e,t){var r,i,n=e.quantizedVertices,a=n.length/3,o=e.octEncodedNormals,s=e.westIndices.length+e.eastIndices.length+e.southIndices.length+e.northIndices.length,c=e.includeWebMercatorT,d=e.rectangle,u=d.west,h=d.south,m=d.east,I=d.north,l=pe.Ellipsoid.clone(e.ellipsoid),g=e.exaggeration,f=e.minimumHeight*g,T=e.maximumHeight*g,p=e.relativeToCenter,y=ye.Transforms.eastNorthUpToFixedFrame(p,l),x=ye.Matrix4.inverseTransformation(y,new ye.Matrix4);c&&(r=Me.WebMercatorProjection.geodeticLatitudeToMercatorAngle(h),i=1/(Me.WebMercatorProjection.geodeticLatitudeToMercatorAngle(I)-r));var N=n.subarray(0,a),M=n.subarray(a,2*a),b=n.subarray(2*a,3*a),C=fe.defined(o),v=new Array(a),w=new Array(a),A=new Array(a),E=c?new Array(a):[],P=Ee;P.x=Number.POSITIVE_INFINITY,P.y=Number.POSITIVE_INFINITY,P.z=Number.POSITIVE_INFINITY;var S=Pe;S.x=Number.NEGATIVE_INFINITY,S.y=Number.NEGATIVE_INFINITY,S.z=Number.NEGATIVE_INFINITY;for(var B=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,V=Number.POSITIVE_INFINITY,W=Number.NEGATIVE_INFINITY,_=0;_<a;++_){var k=N[_],H=M[_],O=k/we,Y=H/we,z=Te.CesiumMath.lerp(f,T,b[_]/we);Se.longitude=Te.CesiumMath.lerp(u,m,O),Se.latitude=Te.CesiumMath.lerp(h,I,Y),Se.height=z,B=Math.min(Se.longitude,B),F=Math.max(Se.longitude,F),V=Math.min(Se.latitude,V),W=Math.max(Se.latitude,W);var j=l.cartographicToCartesian(Se);v[_]=new pe.Cartesian2(O,Y),w[_]=z,A[_]=j,c&&(E[_]=(Me.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Se.latitude)-r)*i),ye.Matrix4.multiplyByPoint(x,j,Ae),pe.Cartesian3.minimumByComponent(Ae,P,P),pe.Cartesian3.maximumByComponent(Ae,S,S)}var G,D,L=He(e.westIndices,function(e,t){return v[e].y-v[t].y}),U=He(e.eastIndices,function(e,t){return v[t].y-v[e].y}),R=He(e.southIndices,function(e,t){return v[t].x-v[e].x}),q=He(e.northIndices,function(e,t){return v[e].x-v[t].x});1!==g&&(D=ye.BoundingSphere.fromPoints(A),G=Ce.OrientedBoundingBox.fromRectangle(d,f,T,l));var J=f;J=Math.min(J,_e(e.westIndices,e.westSkirtHeight,w,v,d,l,x,P,S)),J=Math.min(J,_e(e.southIndices,e.southSkirtHeight,w,v,d,l,x,P,S)),J=Math.min(J,_e(e.eastIndices,e.eastSkirtHeight,w,v,d,l,x,P,S)),J=Math.min(J,_e(e.northIndices,e.northSkirtHeight,w,v,d,l,x,P,S));for(var K=new be.AxisAlignedBoundingBox(P,S,p),Q=new ve.TerrainEncoding(K,J,T,y,C,c),X=Q.getStride(),Z=new Float32Array(a*X+s*X),$=0,ee=0;ee<a;++ee){if(C){var te=2*ee;if(Be.x=o[te],Be.y=o[1+te],1!==g){var re=xe.AttributeCompression.octDecode(Be.x,Be.y,Fe),ie=ye.Transforms.eastNorthUpToFixedFrame(A[ee],l,We),ne=ye.Matrix4.inverseTransformation(ie,Ve);ye.Matrix4.multiplyByPointAsVector(ne,re,re),re.z*=g,pe.Cartesian3.normalize(re,re),ye.Matrix4.multiplyByPointAsVector(ie,re,re),pe.Cartesian3.normalize(re,re),xe.AttributeCompression.octEncode(re,Be)}}$=Q.encode(Z,$,A[ee],v[ee],w[ee],Be,E[ee])}var ae=Math.max(0,2*(s-4)),oe=e.indices.length+3*ae,se=Ne.IndexDatatype.createTypedArray(a+s,oe);se.set(e.indices,0);var ce=1e-4*(F-B),de=1e-4*(W-V),ue=-ce,he=ce,me=de,Ie=-de,le=a*X,ge=e.indices.length;return ge=ke(Z,le,se,ge,e.westIndices,Q,w,v,o,l,d,e.westSkirtHeight,!0,g,r,i,ue,0),ge=ke(Z,le+=e.westIndices.length*X,se,ge,e.southIndices,Q,w,v,o,l,d,e.southSkirtHeight,!1,g,r,i,0,Ie),ge=ke(Z,le+=e.southIndices.length*X,se,ge,e.eastIndices,Q,w,v,o,l,d,e.eastSkirtHeight,!1,g,r,i,he,0),ke(Z,le+=e.eastIndices.length*X,se,ge,e.northIndices,Q,w,v,o,l,d,e.northSkirtHeight,!0,g,r,i,0,me),t.push(Z.buffer,se.buffer),{vertices:Z.buffer,indices:se.buffer,westIndicesSouthToNorth:L,southIndicesEastToWest:R,eastIndicesNorthToSouth:U,northIndicesWestToEast:q,vertexStride:X,center:p,minimumHeight:f,maximumHeight:T,boundingSphere:D,orientedBoundingBox:G,encoding:Q,skirtIndex:e.indices.length}})});
